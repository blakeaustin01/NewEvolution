<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The World That Thinks It Knows You</title>

<style>
  body {
    margin: 0;
    background: #050505;
    overflow: hidden;
    font-family: system-ui, sans-serif;
    color: #ddd;
  }

  #overlay {
    position: absolute;
    bottom: 0;
    width: 100%;
    min-height: 80px;
    padding: 12px;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    font-size: 14px;
  }

  canvas { display: block; }
</style>
</head>

<body>
<canvas id="c"></canvas>
<div id="overlay" id="text">The world is forming an opinion.</div>

<script>
/* =====================
   CANVAS SETUP
===================== */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight - 90;
}
window.addEventListener("resize", resize);
resize();

/* =====================
   PLAYER
===================== */
const player = {
  x: canvas.width / 2,
  y: canvas.height / 2,
  r: 7,
  drift: 0
};

/* =====================
   WORLD ENTITIES
===================== */
let entities = [];
let worldMood = 0; // negative = hostile, positive = aligned
let assumedIdentity = null;
let lastMessage = "";
let time = 0;

function spawnEntities(n = 12) {
  entities = [];
  for (let i = 0; i < n; i++) {
    entities.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      r: 20 + Math.random() * 30,
      vx: Math.random() * 0.4 - 0.2,
      vy: Math.random() * 0.4 - 0.2,
      hue: Math.random() * 360,
      attention: 0
    });
  }
}
spawnEntities();

/* =====================
   INPUT
===================== */
let target = null;
const keys = {};

canvas.addEventListener("touchstart", e => {
  const t = e.touches[0];
  target = { x: t.clientX, y: t.clientY - 90 };
});
canvas.addEventListener("touchmove", e => {
  const t = e.touches[0];
  target = { x: t.clientX, y: t.clientY - 90 };
});
canvas.addEventListener("touchend", () => target = null);

window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);

/* =====================
   BEHAVIOR TRACKING
===================== */
let movementHistory = [];
let compliance = 0;
let defiance = 0;

/* =====================
   UPDATE LOOP
===================== */
function update() {
  time++;

  // Movement
  let moved = false;
  const speed = 1.6 + player.drift;

  if (target) {
    player.x += (target.x - player.x) * 0.06;
    player.y += (target.y - player.y) * 0.06;
    moved = true;
  }

  if (keys.ArrowUp) { player.y -= speed; moved = true; }
  if (keys.ArrowDown) { player.y += speed; moved = true; }
  if (keys.ArrowLeft) { player.x -= speed; moved = true; }
  if (keys.ArrowRight) { player.x += speed; moved = true; }

  if (moved) {
    movementHistory.push({ x: player.x, y: player.y });
    if (movementHistory.length > 200) movementHistory.shift();
  }

  evaluateIdentity();
  evolveWorld();
}

/* =====================
   IDENTITY INFERENCE
===================== */
function evaluateIdentity() {
  if (movementHistory.length < 100) return;

  let edgeBias = movementHistory.filter(p =>
    p.x < 60 || p.y < 60 ||
    p.x > canvas.width - 60 ||
    p.y > canvas.height - 60
  ).length;

  let stillness = 0;
  for (let i = 2; i < movementHistory.length; i++) {
    const a = movementHistory[i];
    const b = movementHistory[i-2];
    if (Math.hypot(a.x-b.x, a.y-b.y) < 4) stillness++;
  }

  let newIdentity =
    edgeBias > 40 ? "avoider" :
    stillness > 40 ? "observer" :
    "interferer";

  if (!assumedIdentity) {
    assumedIdentity = newIdentity;
    speak(`The world assumes you are an ${newIdentity}.`);
  } else if (newIdentity !== assumedIdentity) {
    defiance++;
    worldMood -= 0.5;
    speak(`That does not match who you were supposed to be.`);
    assumedIdentity = newIdentity;
  } else {
    compliance++;
    worldMood += 0.2;
  }
}

/* =====================
   WORLD EVOLUTION
===================== */
function evolveWorld() {
  entities.forEach(e => {
    const dx = player.x - e.x;
    const dy = player.y - e.y;
    const d = Math.hypot(dx, dy);

    if (d < e.r + 30) {
      e.attention += 0.05;
      if (worldMood < 0) {
        player.drift += 0.0005;
      }
    } else {
      e.attention *= 0.99;
    }

    e.x += e.vx * (1 + e.attention);
    e.y += e.vy * (1 + e.attention);

    if (worldMood < -5) {
      e.vx += (Math.random() - 0.5) * 0.02;
      e.vy += (Math.random() - 0.5) * 0.02;
    }
  });

  if (worldMood < -8 && time % 300 === 0) {
    speak("The world is losing patience with your inconsistency.");
  }
}

/* =====================
   TEXT
===================== */
function speak(msg) {
  if (msg === lastMessage) return;
  lastMessage = msg;
  document.getElementById("overlay").innerText = msg;
}

/* =====================
   DRAW
===================== */
function draw() {
  ctx.fillStyle = `rgb(${10-worldMood},${10+worldMood},20)`;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  entities.forEach(e => {
    ctx.fillStyle = `hsla(${e.hue},60%,50%,${0.3+e.attention})`;
    ctx.beginPath();
    ctx.arc(e.x, e.y, e.r + e.attention*20, 0, Math.PI*2);
    ctx.fill();
  });

  ctx.fillStyle = "white";
  ctx.beginPath();
  ctx.arc(player.x, player.y, player.r, 0, Math.PI*2);
  ctx.fill();
}

/* =====================
   LOOP
===================== */
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
